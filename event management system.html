<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Planner Pro</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for custom colors and Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            --primary: #4f46e5;
            --secondary: #ec4899;
        }
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Main Container -->
    <div id="app-container" class="w-full max-w-lg bg-white rounded-xl shadow-2xl p-6 md:p-8 space-y-6">

        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-extrabold text-gray-900" id="header-title">Event Planner Pro</h1>
            <p class="text-sm text-gray-500" id="header-subtitle">Your perfect event starts here.</p>
        </header>

        <!-- Dynamic Content Area -->
        <div id="content-area">
            <!-- Content will be injected here by JavaScript -->
        </div>
    </div>

    <!-- Message Box (Modal) -->
    <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center transform scale-100 transition-all duration-300">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800"></h3>
            <p id="modal-body" class="text-gray-600 mb-6"></p>
            <button onclick="hideMessage()" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                OK
            </button>
        </div>
    </div>
    
    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 text-center flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
            <p class="mt-4 text-lg font-semibold text-gray-700">Generating ideas...</p>
        </div>
    </div>

    <script>
        // --- 0. Gemini API Configuration and Helper ---
        const API_KEY = ""; // Leave as empty string for Canvas environment
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        function showLoading() {
            document.getElementById('loading-modal').classList.remove('hidden');
            document.getElementById('loading-modal').classList.add('flex');
        }

        function hideLoading() {
            document.getElementById('loading-modal').classList.add('hidden');
            document.getElementById('loading-modal').classList.remove('flex');
        }

        async function fetchGemini(userQuery, systemPrompt) {
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            for (let i = 0; i < 3; i++) { // Retry up to 3 times
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        return result.candidates?.[0]?.content?.parts?.[0]?.text || "Generation failed to return text.";
                    } else if (response.status === 429 && i < 2) {
                        // Exponential backoff
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                        continue; 
                    } else {
                        throw new Error(`API returned status ${response.status}`);
                    }
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    if (i < 2) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                        continue;
                    }
                    return "Sorry, the AI feature is currently unavailable. Please try again later.";
                }
            }
        }
        
        // --- 1. Global State Management and Constants ---
        let view = 'login';
        let currentUser = null; // Stores { email: '', id: '' }
        let currentEvent = {}; // Stores details of the event being planned
        let countdownInterval = null; // Used for the live event countdown
        
        // --- CURRENCY CONSTANTS (Updated to INR) ---
        const CURRENCY = "INR";
        const CURRENCY_SYMBOL = "â‚¹";
        
        const BUDGET_COSTS = {
            WHOLE_EVENT: 400000.00, // Full Management (~$5000 USD)
            HALF_EVENT: 200000.00 // Partial Support (~$2500 USD)
        };
        
        // Simulated Database: Email -> { password, id }
        const userDB = {}; 
        
        // Simulated Database: Stored events and reserved dates
        // Date format: YYYY-MM-DD
        const reservedDatesDB = {
            '2025-12-25': 'xmas-party-001' // Example conflict date
        };
        const eventsDB = {}; // Stores full event objects

        // --- 2. Utility Functions ---
        
        /** Formats the amount into the selected currency (INR). */
        function formatCurrency(amount) {
            return amount.toLocaleString('en-IN', { style: 'currency', currency: CURRENCY });
        }

        /** Shows a custom modal message (replaces alert()). */
        function showMessage(title, body) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = body;
            document.getElementById('message-box').classList.remove('hidden');
            document.getElementById('message-box').classList.add('flex');
        }

        /** Hides the custom modal message. */
        function hideMessage() {
            document.getElementById('message-box').classList.add('hidden');
            document.getElementById('message-box').classList.remove('flex');
        }

        /** Clears the countdown interval when navigating away from the confirmation screen. */
        function clearCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        /** Renders the current view based on the global state. */
        function render() {
            // CRITICAL: Clear countdown interval whenever switching views
            clearCountdown();
            
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = '';
            
            // Handle view rendering based on state
            if (!currentUser) {
                if (view === 'register') {
                    renderRegister();
                } else {
                    renderLogin();
                }
            } else {
                switch (view) {
                    case 'welcome':
                        renderWelcome();
                        break;
                    case 'budget':
                        renderBudgetSelection();
                        break;
                    case 'schedule':
                        renderSchedulePicker();
                        break;
                    case 'payment':
                        renderPayment();
                        break;
                    case 'confirmation':
                        renderConfirmation();
                        break;
                    case 'review':
                        renderReview();
                        break;
                    default:
                        renderWelcome();
                }
            }
        }
        
        /** Counts the number of events owned by the current user. */
        function getUserEventCount() {
            let count = 0;
            const userId = currentUser.id;
            for (const id in eventsDB) {
                if (eventsDB[id].userId === userId) {
                    count++;
                }
            }
            return count;
        }

        /** Updates the live countdown display for the current event. */
        function updateCountdown(targetDateStr, targetTimeStr) {
            const countdownEl = document.getElementById('event-countdown-display');
            if (!countdownEl) {
                clearInterval(countdownInterval);
                return;
            }

            // Create a Date object from the YYYY-MM-DD and HH:MM strings
            const targetDateTime = new Date(`${targetDateStr}T${targetTimeStr}:00`);
            const now = new Date();
            const difference = targetDateTime.getTime() - now.getTime();

            if (difference <= 0) {
                clearInterval(countdownInterval);
                countdownEl.innerHTML = '<span class="text-green-600 font-semibold text-lg">Event is Happening Now!</span>';
                return;
            }

            const days = Math.floor(difference / (1000 * 60 * 60 * 24));
            const hours = Math.floor((difference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((difference % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((difference % (1000 * 60)) / 1000);

            // Display in a clean, visual format
            countdownEl.innerHTML = `
                <div class="flex flex-col items-center">
                    <span class="font-mono text-3xl font-bold text-indigo-700">${days}</span> 
                    <span class="text-xs text-gray-500">Days</span>
                </div>
                <span class="text-3xl text-gray-400">:</span>
                <div class="flex flex-col items-center">
                    <span class="font-mono text-3xl font-bold text-indigo-700">${String(hours).padStart(2, '0')}</span> 
                    <span class="text-xs text-gray-500">Hrs</span>
                </div>
                <span class="text-3xl text-gray-400">:</span>
                <div class="flex flex-col items-center">
                    <span class="font-mono text-3xl font-bold text-indigo-700">${String(minutes).padStart(2, '0')}</span> 
                    <span class="text-xs text-gray-500">Min</span>
                </div>
                <span class="text-3xl text-gray-400">:</span>
                <div class="flex flex-col items-center">
                    <span class="font-mono text-3xl font-bold text-indigo-700">${String(seconds).padStart(2, '0')}</span> 
                    <span class="text-xs text-gray-500">Sec</span>
                </div>
            `;
        }

        // --- 3. API Simulation (Frontend Logic) ---

        function simulateRegister(email, password) {
            if (userDB[email]) {
                showMessage("Registration Failed", "This email is already registered.");
                return false;
            }
            const userId = crypto.randomUUID();
            userDB[email] = { password, id: userId };
            showMessage("Success!", "Registration complete. You can now log in.");
            view = 'login';
            return true;
        }

        function simulateLogin(email, password) {
            const user = userDB[email];
            if (user && user.password === password) {
                currentUser = { email, id: user.id };
                showMessage("Welcome Back!", `Welcome, ${email}!`);
                view = 'welcome';
                return true;
            }
            showMessage("Login Failed", "Invalid email or password.");
            return false;
        }
        
        function simulateLogout() {
            currentUser = null;
            currentEvent = {};
            view = 'login';
            render();
        }

        // --- 4. Render Functions for Each Step ---

        function renderLogin() {
            document.getElementById('header-title').textContent = 'Login Portal';
            document.getElementById('header-subtitle').textContent = 'Enter your credentials to manage your events.';

            document.getElementById('content-area').innerHTML = `
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" class="w-full py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
                        Log In
                    </button>
                </form>
                <p class="mt-4 text-center text-sm text-gray-600">
                    Not registered? 
                    <button onclick="view = 'register'; render();" class="text-indigo-600 hover:text-indigo-500 font-medium transition duration-150">
                        Create an account
                    </button>
                </p>
            `;

            document.getElementById('login-form').onsubmit = (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                if (simulateLogin(email, password)) {
                    render();
                }
            };
        }

        function renderRegister() {
            document.getElementById('header-title').textContent = 'Register Account';
            document.getElementById('header-subtitle').textContent = 'Join us to start planning your perfect event!';

            document.getElementById('content-area').innerHTML = `
                <form id="register-form" class="space-y-4">
                    <div>
                        <label for="reg-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="reg-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="reg-password" class="block text-sm font-medium text-gray-700">Set Password</label>
                        <input type="password" id="reg-password" required minlength="6" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" class="w-full py-2 px-4 bg-secondary text-white font-semibold rounded-lg shadow-md hover:bg-pink-600 transition duration-150">
                        Register
                    </button>
                </form>
                <p class="mt-4 text-center text-sm text-gray-600">
                    Already have an account? 
                    <button onclick="view = 'login'; render();" class="text-secondary hover:text-pink-500 font-medium transition duration-150">
                        Log In
                    </button>
                </p>
            `;

            document.getElementById('register-form').onsubmit = (e) => {
                e.preventDefault();
                const email = document.getElementById('reg-email').value;
                const password = document.getElementById('reg-password').value;
                if (simulateRegister(email, password)) {
                    render();
                }
            };
        }

        function renderWelcome() {
            document.getElementById('header-title').textContent = 'Welcome!';
            document.getElementById('header-subtitle').textContent = `What event are you planning, ${currentUser.email.split('@')[0]}?`;
            
            document.getElementById('content-area').innerHTML = `
                <form id="event-name-form" class="space-y-4">
                    <div>
                        <label for="event-name" class="block text-lg font-medium text-gray-700">Event Name</label>
                        <input type="text" id="event-name" required placeholder="e.g., Annual Gala, Birthday Bash" class="mt-2 block w-full px-4 py-3 border-2 border-indigo-300 rounded-lg shadow-inner focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                    </div>
                    <button type="submit" class="w-full py-3 px-4 bg-indigo-600 text-white font-bold rounded-lg shadow-xl hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.01]">
                        Next: Choose Budget
                    </button>
                </form>
                <button onclick="simulateLogout()" class="mt-6 w-full text-sm text-gray-500 hover:text-gray-700 transition duration-150">
                    Log Out
                </button>
            `;

            document.getElementById('event-name-form').onsubmit = (e) => {
                e.preventDefault();
                const eventName = document.getElementById('event-name').value;
                if (eventName.trim()) {
                    currentEvent.name = eventName.trim();
                    view = 'budget';
                    render();
                }
            };
        }

        async function generateBudgetBreakdown(amount, eventName) {
            showLoading();
            const formattedAmount = formatCurrency(amount);
            const prompt = `Generate a realistic and general percentage-based budget breakdown for a ${eventName} event with a total budget of ${formattedAmount}. Provide the response as a clear, formatted list of budget categories and their suggested percentage/amount. Do not include any introductory or concluding sentences.`;
            const systemPrompt = "You are an expert event planner's assistant providing budget allocation advice.";
            
            const result = await fetchGemini(prompt, systemPrompt);
            hideLoading();
            
            const area = document.getElementById('llm-budget-area');
            area.innerHTML = `
                <div class="mt-4 p-4 bg-white border border-secondary rounded-lg shadow-md">
                    <h4 class="font-bold text-lg text-secondary mb-2 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2-3 .895-3 2 1.343 2 3 2m0-8V6m0 10v-2"></path></svg>
                        AI Budget Breakdown Suggestion
                    </h4>
                    <p class="text-sm text-gray-600 mb-2">Based on your ${formattedAmount} budget for a **${eventName}** event:</p>
                    <div class="text-sm text-gray-800 whitespace-pre-wrap">${result}</div>
                </div>
            `;
        }

        function renderBudgetSelection() {
            document.getElementById('header-title').textContent = `Budget for: ${currentEvent.name}`;
            document.getElementById('header-subtitle').textContent = 'Select the management package that fits your needs. (All amounts in Rupees)';

            const wholeEventCost = formatCurrency(BUDGET_COSTS.WHOLE_EVENT);
            const halfEventCost = formatCurrency(BUDGET_COSTS.HALF_EVENT);

            document.getElementById('content-area').innerHTML = `
                <div class="space-y-4">
                    ${createBudgetOption('WHOLE_EVENT', 'Full Management', 'We handle everything from vendors to cleanup.', wholeEventCost)}
                    ${createBudgetOption('HALF_EVENT', 'Partial Support', 'We assist with core logistics and scheduling only.', halfEventCost)}
                    ${createBudgetOption('USER_BUDGET', 'Custom Budget', 'You set the initial total budget for your event.', 'You decide')}
                    
                    <div id="user-budget-input" class="p-4 border border-gray-300 rounded-lg hidden space-y-2 bg-gray-50">
                        <label for="custom-amount" class="block text-sm font-medium text-gray-700">Enter Your Estimated Total Budget (${CURRENCY_SYMBOL})</label>
                        <input type="number" id="custom-amount" min="1000" placeholder="e.g., 150000" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-secondary focus:border-secondary">
                        <button id="breakdown-btn" class="w-full py-2 px-4 bg-secondary text-white font-semibold rounded-lg shadow-md hover:bg-pink-600 transition duration-150 flex items-center justify-center mt-2" disabled>
                            âœ¨ Generate Budget Breakdown
                        </button>
                    </div>
                    <div id="llm-budget-area"></div>

                    <button id="budget-submit" class="w-full py-3 px-4 bg-indigo-600 text-white font-bold rounded-lg shadow-xl hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.01]" disabled>
                        Next: Choose Date & Time
                    </button>
                </div>
            `;
            
            const customAmountInput = document.getElementById('custom-amount');
            const breakdownBtn = document.getElementById('breakdown-btn');
            
            // Event listener for budget selection
            document.querySelectorAll('input[name="budget-type"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const type = e.target.value;
                    currentEvent.budgetType = type;
                    document.getElementById('budget-submit').disabled = false;
                    
                    const customInputContainer = document.getElementById('user-budget-input');
                    if (type === 'USER_BUDGET') {
                        customInputContainer.classList.remove('hidden');
                        customAmountInput.setAttribute('required', 'required');
                        currentEvent.amount = null; // Clear fixed amount
                    } else {
                        customInputContainer.classList.add('hidden');
                        customAmountInput.removeAttribute('required');
                        currentEvent.amount = BUDGET_COSTS[type]; // Set fixed amount
                        document.getElementById('llm-budget-area').innerHTML = '';
                    }
                });
            });

            // Event listener for custom amount input
            customAmountInput.addEventListener('input', () => {
                const amount = parseFloat(customAmountInput.value);
                const isValid = amount >= 1000;
                breakdownBtn.disabled = !isValid;
                if (isValid) {
                    currentEvent.amount = amount;
                } else {
                    currentEvent.amount = null;
                }
            });

            // Event listener for AI Breakdown button
            breakdownBtn.onclick = () => {
                if (currentEvent.amount && currentEvent.name) {
                    generateBudgetBreakdown(currentEvent.amount, currentEvent.name);
                }
            };


            document.getElementById('budget-submit').onclick = () => {
                if (currentEvent.budgetType === 'USER_BUDGET') {
                    const customAmount = customAmountInput.value;
                    if (!customAmount || parseFloat(customAmount) < 1000) {
                        showMessage("Missing Budget", "Please enter a valid budget amount (min â‚¹1000).");
                        return;
                    }
                    currentEvent.amount = parseFloat(customAmount);
                }

                if (currentEvent.budgetType && currentEvent.amount) {
                    view = 'schedule';
                    render();
                } else {
                     showMessage("Selection Required", "Please select a budget type.");
                }
            };
        }

        function createBudgetOption(value, title, description, cost) {
            return `
                <label class="flex items-center p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:bg-indigo-50 transition duration-150 has-[:checked]:border-secondary has-[:checked]:ring-2 has-[:checked]:ring-secondary">
                    <input type="radio" name="budget-type" value="${value}" class="form-radio h-5 w-5 text-secondary border-gray-300 focus:ring-secondary">
                    <div class="ml-4 flex-1">
                        <p class="text-lg font-semibold text-gray-800">${title}</p>
                        <p class="text-sm text-gray-500">${description}</p>
                    </div>
                    <div class="text-xl font-bold text-secondary ml-4">${cost}</div>
                </label>
            `;
        }
        
        function renderSchedulePicker() {
            document.getElementById('header-title').textContent = 'Set Date & Time Range';
            document.getElementById('header-subtitle').textContent = `Scheduling ${currentEvent.name}. Cost: ${formatCurrency(currentEvent.amount)}.`;

            const today = new Date().toISOString().split('T')[0];

            document.getElementById('content-area').innerHTML = `
                <form id="schedule-form" class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Start Date/Time -->
                        <div>
                            <label for="start-date" class="block text-lg font-medium text-gray-700">Start Date</label>
                            <input type="date" id="start-date" required min="${today}" class="mt-2 block w-full px-4 py-3 border-2 border-indigo-300 rounded-lg shadow-inner text-lg">
                        </div>
                        <div>
                            <label for="start-time" class="block text-lg font-medium text-gray-700">Start Time</label>
                            <input type="time" id="start-time" required value="19:00" class="mt-2 block w-full px-4 py-3 border-2 border-indigo-300 rounded-lg shadow-inner text-lg">
                        </div>

                        <!-- End Date/Time -->
                        <div>
                            <label for="end-date" class="block text-lg font-medium text-gray-700">End Date</label>
                            <input type="date" id="end-date" required min="${today}" class="mt-2 block w-full px-4 py-3 border-2 border-indigo-300 rounded-lg shadow-inner text-lg">
                        </div>
                        <div>
                            <label for="end-time" class="block text-lg font-medium text-gray-700">End Time</label>
                            <input type="time" id="end-time" required value="22:00" class="mt-2 block w-full px-4 py-3 border-2 border-indigo-300 rounded-lg shadow-inner text-lg">
                        </div>
                    </div>

                    <p id="date-message" class="text-sm italic text-gray-600 h-4"></p>
                    <button type="submit" id="schedule-submit" class="w-full py-3 px-4 bg-indigo-600 text-white font-bold rounded-lg shadow-xl hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.01]">
                        Next: Payment
                    </button>
                </form>
            `;

            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const dateMessage = document.getElementById('date-message');
            const submitButton = document.getElementById('schedule-submit');

            // Combined validation/conflict check
            const validateDates = () => {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                const startTime = document.getElementById('start-time').value;
                const endTime = document.getElementById('end-time').value;

                if (!startDate || !endDate) {
                    dateMessage.textContent = '';
                    submitButton.disabled = true;
                    return;
                }

                const startDateTime = new Date(`${startDate}T${startTime}:00`);
                const endDateTime = new Date(`${endDate}T${endTime}:00`);

                if (endDateTime <= startDateTime) {
                    dateMessage.textContent = 'ERROR: End date/time must be strictly after the start date/time.';
                    dateMessage.classList.remove('text-green-600');
                    dateMessage.classList.add('text-red-600');
                    submitButton.disabled = true;
                    return;
                }
                
                // Only check for conflict on the start date
                if (reservedDatesDB[startDate]) {
                    dateMessage.textContent = 'CONFLICT: An event is already booked on the start date. Please choose another start date.';
                    dateMessage.classList.remove('text-green-600');
                    dateMessage.classList.add('text-red-600');
                    submitButton.disabled = true;
                    return;
                }

                dateMessage.textContent = 'Dates are available! ðŸŽ‰';
                dateMessage.classList.remove('text-red-600');
                dateMessage.classList.add('text-green-600');
                submitButton.disabled = false;
            };

            // Attach validation to all date/time inputs
            startDateInput.addEventListener('change', validateDates);
            endDateInput.addEventListener('change', validateDates);
            document.getElementById('start-time').addEventListener('change', validateDates);
            document.getElementById('end-time').addEventListener('change', validateDates);
            
            // Initial check if fields are pre-filled
            validateDates();


            document.getElementById('schedule-form').onsubmit = (e) => {
                e.preventDefault();
                
                // Get all values
                currentEvent.startDate = startDateInput.value;
                currentEvent.startTime = document.getElementById('start-time').value;
                currentEvent.endDate = endDateInput.value;
                currentEvent.endTime = document.getElementById('end-time').value;

                // Final check before moving on
                const startDateTime = new Date(`${currentEvent.startDate}T${currentEvent.startTime}:00`);
                const endDateTime = new Date(`${currentEvent.endDate}T${currentEvent.endTime}:00`);

                if (endDateTime <= startDateTime) {
                    showMessage("Date Error", "The end date/time must be after the start date/time.");
                    return;
                }
                
                if (reservedDatesDB[currentEvent.startDate]) {
                    showMessage("Conflict Error", "The selected start date was just booked. Please select a different one.");
                    submitButton.disabled = true;
                    return;
                }
                
                view = 'payment';
                render();
            };
        }
        
        function renderPayment() {
            document.getElementById('header-title').textContent = 'Secure Payment';
            document.getElementById('header-subtitle').textContent = `Finalizing ${currentEvent.name}. Amount Due: ${formatCurrency(currentEvent.amount)}.`;
            
            // Create a unique Event ID and reserve the date before payment
            currentEvent.id = crypto.randomUUID();
            reservedDatesDB[currentEvent.startDate] = currentEvent.id; // Reserve the start date

            document.getElementById('content-area').innerHTML = `
                <form id="payment-form" class="space-y-4 bg-indigo-50 p-6 rounded-xl shadow-inner">
                    <p class="text-lg font-semibold text-gray-700">Enter Payment Details (Simulated)</p>
                    <div>
                        <label for="card-number" class="block text-sm font-medium text-gray-700">Card Number</label>
                        <input type="text" id="card-number" required placeholder="XXXX XXXX XXXX XXXX" maxlength="16" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="card-expiry" class="block text-sm font-medium text-gray-700">Expiry (MM/YY)</label>
                            <input type="text" id="card-expiry" required placeholder="MM/YY" maxlength="5" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="card-cvv" class="block text-sm font-medium text-gray-700">CVV</label>
                            <input type="text" id="card-cvv" required placeholder="123" maxlength="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full py-3 px-4 bg-secondary text-white font-bold rounded-lg shadow-xl hover:bg-pink-600 transition duration-150 transform hover:scale-[1.01]">
                        Pay ${formatCurrency(currentEvent.amount)} and Confirm
                    </button>
                </form>
            `;

            document.getElementById('payment-form').onsubmit = (e) => {
                e.preventDefault();
                // Simulate successful payment
                currentEvent.status = 'PAID';
                currentEvent.userId = currentUser.id;
                eventsDB[currentEvent.id] = currentEvent; // Save to event DB
                view = 'confirmation';
                render();
            };
        }
        
        async function generateInvitationDraft(event) {
            document.getElementById('llm-draft-area').innerHTML = ''; // Clear existing
            showLoading();
            const prompt = `Write a short, professional, and friendly digital invitation draft for the event named "${event.name}". The event is scheduled from ${event.startDate} at ${event.startTime} to ${event.endDate} at ${event.endTime}. Focus only on the invitation text itself.`;
            const systemPrompt = "You are a creative copywriter for event invitations. Provide only the body text of the invitation draft, using clear and welcoming language. Wrap the text in double quotes for easy copying.";
            
            const result = await fetchGemini(prompt, systemPrompt);
            hideLoading();

            // Strip surrounding quotes if they exist
            const draftText = result.replace(/^"|"$/g, '').trim();

            const area = document.getElementById('llm-draft-area');
            area.innerHTML = `
                <div class="mt-4 p-4 bg-gray-50 border border-indigo-300 rounded-lg shadow-inner space-y-3">
                    <h4 class="font-bold text-lg text-indigo-700 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8m-2 4v7a2 2 0 01-2 2H5a2 2 0 01-2-2v-7"></path></svg>
                        AI Invitation Draft
                    </h4>
                    <textarea id="invitation-draft-text" rows="6" readonly class="w-full p-2 border rounded-md bg-white text-sm text-gray-800">${draftText}</textarea>
                    <button onclick="copyToClipboard('invitation-draft-text')" class="w-full py-2 px-4 bg-indigo-200 text-indigo-700 font-semibold rounded-lg hover:bg-indigo-300 transition duration-150 text-sm">
                        Copy Draft to Clipboard
                    </button>
                </div>
            `;
        }
        
        function copyToClipboard(elementId) {
            const copyText = document.getElementById(elementId).value;
            // Fallback for secure context issues in iframes
            const textarea = document.createElement('textarea');
            textarea.value = copyText;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showMessage("Copied!", "Invitation draft copied to clipboard.");
                } else {
                    showMessage("Copy Failed", "Unable to copy text. Please select and copy manually.");
                }
            } catch (err) {
                showMessage("Copy Failed", "Unable to copy text. Please select and copy manually.");
            }
            document.body.removeChild(textarea);
        }


        function renderConfirmation() {
            const totalEvents = getUserEventCount();
            const startDateTime = `${currentEvent.startDate} at ${currentEvent.startTime}`;
            const endDateTime = `${currentEvent.endDate} at ${currentEvent.endTime}`;
            
            document.getElementById('header-title').textContent = 'Event Registered!';
            document.getElementById('header-subtitle').textContent = `Payment Complete for ${currentEvent.name}.`;

            document.getElementById('content-area').innerHTML = `
                <div class="text-center p-6 bg-green-50 border-t-4 border-green-400 rounded-xl space-y-4 shadow-md">
                    <svg class="w-12 h-12 text-green-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <p class="text-xl font-bold text-green-700">You are all set!</p>
                    <p class="text-gray-700">Your event, **${currentEvent.name}**, is successfully booked and confirmed. The schedule is:</p>
                    <div class="text-lg font-extrabold text-indigo-600 space-y-1">
                        <p>Start: ${startDateTime}</p>
                        <p>End: ${endDateTime}</p>
                    </div>
                </div>
                
                <!-- Event Statistics and Countdown -->
                <div class="mt-4 p-4 bg-indigo-50 rounded-xl border border-indigo-200">
                    <h3 class="text-lg font-semibold text-indigo-700 mb-4 border-b border-indigo-200 pb-2">Your Planning Overview</h3>
                    
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-sm text-gray-600 font-medium">Total Events Planned:</span>
                        <span class="text-3xl font-extrabold text-secondary">${totalEvents}</span>
                    </div>

                    <div>
                        <p class="text-sm text-gray-600 font-medium mb-2">Countdown to **${currentEvent.name}** Start:</p>
                        <div id="event-countdown-display" class="flex justify-between items-end bg-white p-3 rounded-lg border">
                            <!-- Countdown will be injected here by updateCountdown() -->
                        </div>
                    </div>
                </div>
                <!-- End Event Statistics and Countdown -->

                <div class="mt-8 space-y-4">
                    <button id="generate-draft-btn" class="w-full py-3 px-4 bg-secondary text-white font-bold rounded-lg shadow-xl hover:bg-pink-600 transition duration-150 flex items-center justify-center">
                        âœ¨ Generate AI Invitation Draft
                    </button>
                    <div id="llm-draft-area"></div>

                    <button onclick="view = 'review'; render();" class="w-full py-3 px-4 bg-indigo-600 text-white font-bold rounded-lg shadow-xl hover:bg-indigo-700 transition duration-150">
                        Complete & Give Review
                    </button>
                    <button onclick="simulateCancelEvent('${currentEvent.id}')" class="w-full py-3 px-4 bg-red-100 text-red-600 font-semibold rounded-lg hover:bg-red-200 transition duration-150">
                        Cancel Event (Removal Option)
                    </button>
                </div>
            `;
            
            // Start the countdown to the START date/time and set the interval
            updateCountdown(currentEvent.startDate, currentEvent.startTime);
            countdownInterval = setInterval(() => updateCountdown(currentEvent.startDate, currentEvent.startTime), 1000);

            document.getElementById('generate-draft-btn').onclick = () => {
                generateInvitationDraft(currentEvent);
            };
        }

        function simulateCancelEvent(eventId) {
            const eventToRemove = eventsDB[eventId];
            if (!eventToRemove) {
                showMessage("Error", "Event not found.");
                return;
            }

            // Simulated Backend Deletion
            delete reservedDatesDB[eventToRemove.startDate];
            delete eventsDB[eventId];
            
            showMessage("Event Cancelled", `The event **${eventToRemove.name}** has been successfully removed.`);

            // Reset state and go back to welcome
            currentEvent = {};
            view = 'welcome';
            render();
        }

        function renderReview() {
            document.getElementById('header-title').textContent = 'Review & Rating';
            document.getElementById('header-subtitle').textContent = 'Your feedback helps us improve our service.';

            document.getElementById('content-area').innerHTML = `
                <form id="review-form" class="space-y-6">
                    <div>
                        <label class="block text-lg font-medium text-gray-700 mb-2">Service Rating</label>
                        <div id="rating-stars" class="flex justify-center space-x-2 text-3xl cursor-pointer">
                            ${[1, 2, 3, 4, 5].map(i => `<span data-rating="${i}" class="text-gray-300 hover:text-yellow-400 transition-colors">â˜…</span>`).join('')}
                        </div>
                        <input type="hidden" id="review-rating" required value="0">
                    </div>
                    <div>
                        <label for="review-text" class="block text-lg font-medium text-gray-700">Your Feedback</label>
                        <textarea id="review-text" rows="4" required placeholder="Tell us about your experience..." class="mt-2 block w-full px-4 py-3 border-2 border-gray-300 rounded-lg shadow-inner focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>
                    <button type="submit" class="w-full py-3 px-4 bg-indigo-600 text-white font-bold rounded-lg shadow-xl hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.01]">
                        Submit Review & Finish
                    </button>
                </form>
            `;

            const ratingInput = document.getElementById('review-rating');
            const stars = document.getElementById('rating-stars').children;

            // Star Rating Logic
            Array.from(stars).forEach(star => {
                star.addEventListener('click', () => {
                    const rating = parseInt(star.getAttribute('data-rating'));
                    ratingInput.value = rating;
                    Array.from(stars).forEach((s, index) => {
                        s.classList.toggle('text-yellow-400', index < rating);
                        s.classList.toggle('text-gray-300', index >= rating);
                    });
                });
            });

            document.getElementById('review-form').onsubmit = (e) => {
                e.preventDefault();
                // Simulate saving review (ratingInput.value and reviewText.value)
                showMessage("Thank You!", "Your review has been submitted. We appreciate your feedback!");
                
                // Reset flow
                currentEvent = {};
                view = 'welcome';
                render();
            };
        }

        // --- 5. Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Pre-fill one test user for easy login
            if (!userDB['test@example.com']) {
                userDB['test@example.com'] = { password: 'password', id: 'user-001' };
            }
            render();
        });

    </script>
</body>
</html>